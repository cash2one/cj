<?php/** * SalesBusinessController.class.php * $author$ */namespace Sales\Controller\Api;class SalesBusinessController extends AbstractController {	/**	 * 新增商机	 * @return bool	 * $author chen	 */	public function Create_business_post() {		// 商机信息		$business = array();		// 用户提交的参数		$params = I('request.');		// 非用户提交的扩展参数		$extend = array(			'uid' => $this->_login->user['m_uid'],			'username' => $this->_login->user['m_username']		);		// 客户ID		$sc_id = (int)$params['sc_id'];		// 客户id不能为空		if (empty($sc_id)) {			$this->_set_error('_ERR_CUSTOMER_SCIDS_MESSAGE');			return false;		}		$sc_d = D('Sales/SalesCustomer', 'Service');		$customer = array();		$sc_d->customer_detail($customer, $sc_id);		// 客户是否存在 通过客户ID获得客户信息		if (empty($customer)) {			$this->_set_error('_ERR_CUSTOMER_MESSAGE');			return false;		}		// 获得客户来源		$sc_source = $customer['sc_source'];		$params['sb_source'] = $sc_source;		// 如果新增操作失败		$serv_sb = D('Sales/SalesBusiness', 'Service');		if (!$serv_sb->create_business($business, $params, $extend)) {			E($serv_sb->get_errcode() . ':' . $serv_sb->get_errmsg());			return false;		}		$this->_result = $business['sb_id'];		return true;	}	/**	 * 编辑商机	 * @return bool	 * $author chen	 */	public function Edit_business_post() {		// 用户提交的参数		$params = I('request.');		// 非用户提交的扩展参数		$extend = array(			'uid' => $this->_login->user['m_uid'],			'username' => $this->_login->user['m_username']		);		// 如果新增操作失败		$serv_sb = D('Sales/SalesBusiness', 'Service');		if (!$serv_sb->edit_business($params, $extend)) {			E($serv_sb->get_errcode() . ':' . $serv_sb->get_errmsg());			return false;		}		return true;	}	/**	 * 批量删除商机	 * @return bool	 * $author chen	 */	public function Del_Business_get() {		// 用户提交的参数商机ID		$sb_ids = I('get.sb_ids');		// 如果删除操作失败		$serv_sb = D('Sales/SalesBusiness', 'Service');		if (!$serv_sb->del_business($sb_ids)) {			E($serv_sb->get_errcode() . ':' . $serv_sb->get_errmsg());			return false;		}		return true;	}	/**	 * 商机列表查询	 * @return bool	 * $author chen	 */	public function List_business_get() {		//请求参数		$params = I('request.');		$list_business = array();		// 每页条数		$limit = (int)$params["limit"];		$page = $params["page"];		$order_by = $params["orderby"];		// 判断每页条数是否正确 ,如果不合法赋予系统默认值		if ($limit < cfg('perpage_min') || $limit > cfg('perpage_max')) {			$limit = $this->_plugin->setting['perpage'];		}		list($start, $limit, $page) = page_limit($page, $limit);		// 分页参数		$page_option = array(			$start,			$limit		);		// 获得商机列表，如果获取失败		$serv_sb = D('Sales/SalesBusiness', 'Service');		if (!$serv_sb->list_business($list_business, $params, $page_option, $order_by)) {			E($serv_sb->get_errcode() . ':' . $serv_sb->get_errmsg());			return false;		}		// 格式化		$serv_fmt = D('Sales/Format', 'Service');		$serv_fmt->business_format($list_business);		// 列表总数		$count = $serv_sb->count_by_condition($params);		$this->_result = array(			"total" => $count,			"limit" => $limit,			"data" => $list_business		);		return true;	}	/**	 * 变更商机负责人	 * $author songshuangfeng	 */	public function Change_manager_get() {		// 用户提交的参数		$params = I('request.');		// 非用户提交的扩展参数		$extend = array(			'uid' => $this->_login->user['m_uid'],		);		$serv_sb = D('Sales/SalesBusiness', 'Service');		//判断是否变更成功		if (!$serv_sb->change_manager($params, $extend)) {			E($serv_sb->get_errcode() . ':' . $serv_sb->get_errmsg());			return false;		}		return true;	}	/**	 * 商机详情	 * @param int $sb_id 商机id	 * @return business_inf:商机信息  manager_inf:负责人信息	 * $author zhubeihai	 */	public function Business_detail_get() {		// 商机信息		$business_detail = array ();		// 用户提交的参数		$params = I('request.');		// 如果新增操作失败		$serv_sb = D('Sales/SalesBusiness', 'Service');		if (!$serv_sb->business_detail($business_detail, $params['sb_id'])) {			E($serv_sb->get_errcode().':'.$serv_sb->get_errmsg());			return false;		}		$this->_result = $business_detail;		return true;	}	/**	 * 数据管理	 * $author songshuangfeng	 */	public function Data_Management_get() {		// 获得请求参数		$params = I('request.');		$serv_sb = D('Sales/SalesBusiness', 'Service');		$data_manage = array();		// 判断是否获取数据管理成功		if (!$serv_sb->data_management($data_manage, $params)) {			E($serv_sb->get_errcode() . ':' . $serv_sb->get_errmsg());			return false;		}		$this->_result = $data_manage;		return true;	}}